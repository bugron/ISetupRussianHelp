<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"><title>Вывести мессажд, если на диске не хватает места</title><link rel="stylesheet" type="text/css" href="css.css">
<script language='jscript' type='text/javascript' src='copycode.js'></script>
<script type="text/javascript" src="includer.js"></script></head><body><div id="heading"><h1>» Inno Setup Faq. Вывести мессажд, если на диске не хватает места</h1></div><br>
<script language="javascript" type="text/javascript">includeSyntax('delphi');</script><code id="delphi_Tc4NTM">
<input type="button" value="Копировать в буфер обмена" onClick="copyToClipboard( taCode1, theCode1 );">
<blockquote id="theCode1"><font>
#define&nbsp;NeedSize&nbsp;10240<br>
;;Если&nbsp;у&nbsp;вас&nbsp;архивы&nbsp;FreeArc,&nbsp;то&nbsp;сдесь&nbsp;укажите&nbsp;сколько&nbsp;необходимо&nbsp;места&nbsp;в&nbsp;Мб<br>
;;Иначе&nbsp;просто&nbsp;закоментируйте&nbsp;строку<br>
<br>
[Setup]<br>
AppName=My&nbsp;Program<br>
AppVerName=My&nbsp;Program&nbsp;v&nbsp;1.5<br>
DefaultDirName={pf}\My&nbsp;Program<br>
DisableFinishedPage=yes<br>
OutputDir=.<br>
Compression=lzma/ultra<br>
InternalCompressLevel=ultra<br>
SolidCompression=yes<br>
<br>
[Languages]<br>
Name:&nbsp;ENG;&nbsp;MessagesFile:&nbsp;&quot;compiler:Default.isl&quot;<br>
Name:&nbsp;RUS;&nbsp;MessagesFile:&nbsp;&quot;compiler:Languages\Russian.isl&quot;<br>
<br>
[Files]<br>
Source:&nbsp;{win}\help\*.hlp;&nbsp;DestDir:&nbsp;{app}\Files;&nbsp;Flags:&nbsp;external<br>
<br>
[CustomMessages]<br>
RUS.FreeSpace=Доступно&nbsp;места&nbsp;на&nbsp;диске:<br>
RUS.NeedSpace=Требуется&nbsp;места&nbsp;на&nbsp;диске:<br>
ENG.FreeSpace=Free&nbsp;space&nbsp;on&nbsp;disk:<br>
ENG.NeedSpace=Need&nbsp;space&nbsp;on&nbsp;disk:<br>
<br>
[Code]<br>
var<br>
NeedSpaceLabel,FreeSpaceLabel:&nbsp;TLabel;<br>
FreeMB,&nbsp;TotalMB:&nbsp;Cardinal;<br>
SizeStr:&nbsp;String;<br>
SizeInt:&nbsp;Integer;<br>
SymbolNumber:&nbsp;Integer;<br>
<br>
function&nbsp;NumToStr(Float:&nbsp;Extended):&nbsp;String;<br>
Begin<br>
Result:=&nbsp;Format('%.2n',&nbsp;[Float]);&nbsp;StringChange(Result,&nbsp;',',&nbsp;'.');<br>
while&nbsp;((Result[Length(Result)]&nbsp;=&nbsp;'0')&nbsp;or&nbsp;(Result[Length(Result)]&nbsp;=&nbsp;'.'))&nbsp;and&nbsp;(Pos('.',&nbsp;Result)&nbsp;&gt;&nbsp;0)&nbsp;do<br>
SetLength(Result,&nbsp;Length(Result)-1);<br>
end;<br>
<br>
function&nbsp;GetSize():&nbsp;Integer;<br>
begin<br>
SizeStr:=&nbsp;WizardForm.DiskSpaceLabel.Caption;<br>
for&nbsp;SymbolNumber:=&nbsp;97&nbsp;to&nbsp;122&nbsp;do&nbsp;begin<br>
while&nbsp;(Pos(Chr(SymbolNumber),&nbsp;SizeStr)&nbsp;&gt;&nbsp;0)&nbsp;do&nbsp;Delete(SizeStr,&nbsp;Pos(Chr(SymbolNumber),&nbsp;SizeStr),1);&nbsp;///Находим&nbsp;все&nbsp;символы&nbsp;нижнего&nbsp;регистра&nbsp;и&nbsp;удаляем<br>
while&nbsp;(Pos(AnsiUppercase(Chr(SymbolNumber)),&nbsp;SizeStr)&nbsp;&gt;&nbsp;0)&nbsp;do&nbsp;Delete(SizeStr,&nbsp;Pos(AnsiUppercase(Chr(SymbolNumber)),&nbsp;SizeStr),1);&nbsp;end;&nbsp;///Находим&nbsp;все&nbsp;символы&nbsp;верхнего&nbsp;регистра&nbsp;и&nbsp;удаляем<br>
for&nbsp;SymbolNumber:=&nbsp;192&nbsp;to&nbsp;255&nbsp;do&nbsp;begin<br>
while&nbsp;(Pos(Chr(SymbolNumber),&nbsp;SizeStr)&nbsp;&gt;&nbsp;0)&nbsp;do&nbsp;Delete(SizeStr,&nbsp;Pos(Chr(SymbolNumber),&nbsp;SizeStr),1);&nbsp;end;&nbsp;///Находим&nbsp;все&nbsp;символы&nbsp;нижнего&nbsp;регистра&nbsp;и&nbsp;удаляем<br>
while&nbsp;(Pos('.',&nbsp;SizeStr)&nbsp;&gt;&nbsp;0)&nbsp;do&nbsp;Delete(SizeStr,&nbsp;Pos('.',&nbsp;SizeStr),&nbsp;1)&nbsp;///Удаляем&nbsp;точки<br>
Delete(SizeStr,&nbsp;Pos(',',&nbsp;SizeStr),&nbsp;5)&nbsp;///Удаляем&nbsp;дробную&nbsp;часть<br>
Result:=&nbsp;StrToInt(Trim(SizeStr));&nbsp;///Переводим&nbsp;в&nbsp;число<br>
end;<br>
<br>
function&nbsp;CompareNum(FirstNum,&nbsp;SecondNum:&nbsp;Integer):&nbsp;Boolean;<br>
begin<br>
if&nbsp;FirstNum&nbsp;&lt;&nbsp;SecondNum&nbsp;then&nbsp;Result:=&nbsp;False&nbsp;else&nbsp;Result:=&nbsp;True;<br>
end;<br>
<br>
function&nbsp;MbOrTb(Byte:&nbsp;Extended):&nbsp;String;<br>
begin<br>
if&nbsp;Byte&nbsp;&lt;&nbsp;1024&nbsp;then&nbsp;Result:=&nbsp;NumToStr(Byte)&nbsp;+&nbsp;'&nbsp;Мб'&nbsp;else<br>
if&nbsp;Byte/1024&nbsp;&lt;&nbsp;1024&nbsp;then&nbsp;Result:=&nbsp;NumToStr(round(Byte/1024*100)/100)&nbsp;+&nbsp;'&nbsp;Гб'&nbsp;else<br>
Result:=&nbsp;NumToStr(round((Byte/(1024*1024))*100)/100)&nbsp;+&nbsp;'&nbsp;Тб'<br>
end;<br>
procedure&nbsp;GetFreeSpaceCaption(Sender:&nbsp;TObject);<br>
var&nbsp;Path:&nbsp;String;<br>
begin<br>
Path&nbsp;:=&nbsp;ExtractFileDrive(WizardForm.DirEdit.Text);<br>
GetSpaceOnDisk(Path,&nbsp;True,&nbsp;FreeMB,&nbsp;TotalMB);<br>
FreeSpaceLabel.Caption:=&nbsp;ExpandConstant('{cm:FreeSpace}&nbsp;')&nbsp;+&nbsp;MbOrTb(FreeMB)<br>
NeedSpaceLabel.Caption&nbsp;:=&nbsp;ExpandConstant('{cm:NeedSpace}&nbsp;')&nbsp;+&nbsp;MbOrTb(SizeInt)<br>
if&nbsp;WizardForm.CurPageID&nbsp;=&nbsp;wpSelectDir&nbsp;then&nbsp;begin<br>
begin<br>
WizardForm.NextButton.Enabled:=&nbsp;CompareNum(FreeMB,&nbsp;SizeInt)<br>
if&nbsp;&nbsp;CompareNum(FreeMB,&nbsp;SizeInt)&nbsp;=&nbsp;false&nbsp;then<br>
MsgBox('У&nbsp;вас&nbsp;на&nbsp;диске&nbsp;не&nbsp;хватает&nbsp;места,&nbsp;выберите&nbsp;другой&nbsp;раздел.&nbsp;Требуемый&nbsp;размер'&nbsp;+&nbsp;'&nbsp;'&nbsp;+&nbsp;IntToStr(SizeInt)&nbsp;+&nbsp;'&nbsp;Мб',&nbsp;mbError,&nbsp;mb_ok);<br>
end;<br>
end;<br>
end;<br>
<br>
procedure&nbsp;InitializeWizard();<br>
begin<br>
WizardForm.DiskSpaceLabel.Hide;<br>
#ifdef&nbsp;NeedSize<br>
SizeInt:=&nbsp;{#NeedSize}<br>
#else<br>
SizeInt:=&nbsp;GetSize;<br>
#endif<br>
<br>
NeedSpaceLabel&nbsp;:=&nbsp;TLabel.Create(WizardForm);<br>
NeedSpaceLabel.SetBounds(ScaleX(0),&nbsp;ScaleY(198),&nbsp;ScaleX(209),&nbsp;ScaleY(13))<br>
NeedSpaceLabel.Parent&nbsp;:=&nbsp;WizardForm.SelectDirPage;<br>
NeedSpaceLabel.Transparent:=true;<br>
<br>
FreeSpaceLabel&nbsp;:=&nbsp;TLabel.Create(WizardForm);<br>
FreeSpaceLabel.SetBounds(ScaleX(0),&nbsp;ScaleY(216),&nbsp;ScaleX(209),&nbsp;ScaleY(13))<br>
FreeSpaceLabel.Parent&nbsp;:=&nbsp;WizardForm.SelectDirPage;<br>
FreeSpaceLabel.Transparent:=true;<br>
<br>
WizardForm.DirEdit.OnChange:=&nbsp;@GetFreeSpaceCaption;<br>
WizardForm.DirEdit.Text:=&nbsp;WizardForm.DirEdit.Text&nbsp;+&nbsp;#0;<br>
end;<br>
<br>
procedure&nbsp;CurPageChanged(CurPageID:&nbsp;Integer);<br>
begin<br>
if&nbsp;CurPageID&nbsp;=&nbsp;wpSelectDir&nbsp;then&nbsp;begin<br>
GetFreeSpaceCaption(nil)<br>
end;<br>
end;<br>
</font></blockquote><textarea id="taCode1" style="display:none;" rows="1" cols="5"></textarea><textarea id='taCode' style='display:none;' rows='1' cols='20'></textarea></code><script language="javascript" type="text/javascript">highlightSyntax('delphi_Tc4NTM','delphi');</script><br><div id="heading"><h1><font size="1" face="Consolas">Copyright (c) <a href="http://www.krinkels.org/" target="_blank">Krinkels Inc</a></font></h1></div></body></html>