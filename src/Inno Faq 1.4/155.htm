<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"><title>Копирование папки (отдельная страница)</title><link rel="stylesheet" type="text/css" href="css.css">
<script language='jscript' type='text/javascript' src='copycode.js'></script>
<script type="text/javascript" src="includer.js"></script></head><body><div id="heading"><h1>» Inno Setup Faq. Копирование папки (отдельная страница)</h1></div><br>
<script language="javascript" type="text/javascript">includeSyntax('delphi');</script><code id="delphi_Tc4NTM">
<input type="button" value="Копировать в буфер обмена" onClick="copyToClipboard( taCode1, theCode1 );">
<blockquote id="theCode1"><font>
[Setup]<br>
AppName=My&nbsp;Program<br>
AppVerName=My&nbsp;Program&nbsp;v.1.2<br>
DefaultDirName={pf}\My&nbsp;Program<br>
<br>
[Languages]<br>
Name:&nbsp;ru;&nbsp;MessagesFile:&nbsp;compiler:Languages\Russian.isl<br>
<br>
[Code]<br>
const<br>
&nbsp;&nbsp;BlockSize&nbsp;=&nbsp;65536;<br>
&nbsp;&nbsp;PM_REMOVE&nbsp;=&nbsp;1;<br>
&nbsp;&nbsp;WM_QUIT&nbsp;&nbsp;&nbsp;=&nbsp;$0012;<br>
<br>
var<br>
&nbsp;&nbsp;Page:&nbsp;TInputDirWizardPage;<br>
&nbsp;&nbsp;PB,PB2:&nbsp;TNewProgressBar;<br>
&nbsp;&nbsp;L1,L2,L3:TNewStaticText;<br>
&nbsp;&nbsp;DS,CS:Extended;<br>
&nbsp;&nbsp;CancelBtn:TButton;<br>
&nbsp;&nbsp;CancelOperation:boolean;<br>
<br>
function&nbsp;PeekMessage(var&nbsp;lpMsg:&nbsp;TMsg;&nbsp;hWnd:&nbsp;HWND;&nbsp;wMsgFilterMin,&nbsp;wMsgFilterMax,&nbsp;wRemoveMsg:&nbsp;UINT):&nbsp;BOOL;&nbsp;external&nbsp;'PeekMessageA@user32.dll&nbsp;stdcall';<br>
function&nbsp;TranslateMessage(const&nbsp;lpMsg:&nbsp;TMsg):&nbsp;BOOL;&nbsp;external&nbsp;'TranslateMessage@user32.dll&nbsp;stdcall';<br>
function&nbsp;DispatchMessage(const&nbsp;lpMsg:&nbsp;TMsg):&nbsp;Longint;&nbsp;external&nbsp;'DispatchMessageA@user32.dll&nbsp;stdcall';<br>
<br>
procedure&nbsp;AppProcessMessage;<br>
var<br>
&nbsp;&nbsp;Msg:&nbsp;TMsg;<br>
begin<br>
&nbsp;&nbsp;while&nbsp;PeekMessage(Msg,&nbsp;WizardForm.Handle,&nbsp;0,&nbsp;0,&nbsp;PM_REMOVE)&nbsp;do<br>
&nbsp;&nbsp;&nbsp;&nbsp;begin<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TranslateMessage(Msg);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DispatchMessage(Msg);<br>
&nbsp;&nbsp;&nbsp;&nbsp;end;<br>
end;<br>
<br>
procedure&nbsp;CopyFile_(Source,Target:&nbsp;string);<br>
var<br>
&nbsp;&nbsp;FileSize,ElapsedSize,CopySize:LongWord;<br>
&nbsp;&nbsp;SourceStream,TargetStream:TFileStream;<br>
&nbsp;&nbsp;a:Extended;<br>
begin<br>
&nbsp;&nbsp;SourceStream:=TFileStream.Create(Source,fmOpenRead);<br>
&nbsp;&nbsp;TargetStream:=TFileStream.Create(Target,fmCreate);<br>
&nbsp;&nbsp;ElapsedSize:=SourceStream.Size-SourceStream.Position;<br>
&nbsp;&nbsp;FileSize:=SourceStream.Size;<br>
&nbsp;&nbsp;PB.Max:=100;<br>
&nbsp;&nbsp;PB.Position:=0;<br>
&nbsp;&nbsp;L1.Caption:=ExtractFileName(Source);<br>
&nbsp;&nbsp;L2.Caption:='0&nbsp;%';<br>
&nbsp;&nbsp;while&nbsp;ElapsedSize&gt;0&nbsp;do&nbsp;begin<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;ElapsedSize&lt;BlockSize&nbsp;then&nbsp;CopySize:=ElapsedSize&nbsp;else&nbsp;CopySize:=BlockSize;<br>
&nbsp;&nbsp;&nbsp;&nbsp;TargetStream.CopyFrom(SourceStream,CopySize);<br>
&nbsp;&nbsp;&nbsp;&nbsp;ElapsedSize:=SourceStream.Size-SourceStream.Position;<br>
&nbsp;&nbsp;&nbsp;&nbsp;a:=(ElapsedSize&nbsp;div&nbsp;FileSize)*100;<br>
&nbsp;&nbsp;&nbsp;&nbsp;a:=100-a;&nbsp;///хз&nbsp;че&nbsp;здесь&nbsp;за&nbsp;глюки,&nbsp;но&nbsp;писать&nbsp;эти&nbsp;действия&nbsp;в&nbsp;одну&nbsp;строчку&nbsp;нельзя<br>
&nbsp;&nbsp;&nbsp;&nbsp;PB.Position:=Round(a);///SourceStream.Position;<br>
&nbsp;&nbsp;&nbsp;&nbsp;L2.Caption:=IntToStr(PB.Position)+'&nbsp;%'<br>
&nbsp;&nbsp;&nbsp;&nbsp;L2.Invalidate;<br>
&nbsp;&nbsp;&nbsp;&nbsp;CS:=CS+BlockSize;///(1024*1024);<br>
&nbsp;&nbsp;&nbsp;&nbsp;a:=CS*100;&nbsp;&nbsp;&nbsp;///такая&nbsp;же&nbsp;ересь,&nbsp;написав&nbsp;все<br>
&nbsp;&nbsp;&nbsp;&nbsp;a:=a/DS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;///в&nbsp;одну&nbsp;строку&nbsp;ни&nbsp;хрена&nbsp;не&nbsp;считается<br>
&nbsp;&nbsp;&nbsp;&nbsp;PB2.Position:=Round(a);///Round(CS*100/DS);<br>
&nbsp;&nbsp;&nbsp;&nbsp;L3.Caption:=IntToStr(PB2.Position)+'&nbsp;%'<br>
&nbsp;&nbsp;&nbsp;&nbsp;AppProcessMessage;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;CancelOperation&nbsp;then&nbsp;Break;<br>
&nbsp;&nbsp;end;<br>
&nbsp;&nbsp;///FileSetDate(TargetStream.Handle,FileGetDate(SourceStream.Handle));<br>
&nbsp;&nbsp;///дату&nbsp;файла&nbsp;надобы&nbsp;сменить&nbsp;на&nbsp;старую,&nbsp;да&nbsp;возиться&nbsp;лень<br>
&nbsp;&nbsp;TargetStream.Free;<br>
&nbsp;&nbsp;SourceStream.Free;<br>
&nbsp;&nbsp;if&nbsp;CancelOperation&nbsp;then&nbsp;DeleteFile(Target);<br>
end;<br>
<br>
procedure&nbsp;CopyDir(const&nbsp;FromDir,ToDir,FileMask:string;IncludeSubDirs:boolean);<br>
var<br>
&nbsp;&nbsp;FindRec:TFindRec;<br>
&nbsp;&nbsp;sFileName,fd,td:string;<br>
///i,j:Int64;<br>
&nbsp;&nbsp;ii:integer;<br>
begin<br>
&nbsp;&nbsp;fd:=AddBackslash(FromDir);<br>
&nbsp;&nbsp;td:=AddBackslash(ToDir);<br>
&nbsp;&nbsp;ForceDirectories(td);<br>
&nbsp;&nbsp;if&nbsp;FindFirst(fd+FileMask,FindRec)&nbsp;then&nbsp;begin<br>
&nbsp;&nbsp;&nbsp;&nbsp;try<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;repeat<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sFileName:=fd+FindRec.Name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((FindRec.Attributes&nbsp;and&nbsp;FILE_ATTRIBUTE_DIRECTORY)=0)&nbsp;then&nbsp;CopyFile_(sFileName,td+FindRec.Name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;IncludeSubDirs&nbsp;then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(FindRec.Name&lt;&gt;'')&nbsp;and&nbsp;(FindRec.Name&lt;&gt;'.')&nbsp;and&nbsp;(FindRec.Name&lt;&gt;'..')&nbsp;then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CopyDir(sFileName,td+FindRec.Name,FileMask,IncludeSubDirs);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AppProcessMessage;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;until&nbsp;not&nbsp;(FindNext(FindRec)&nbsp;and&nbsp;not&nbsp;CancelOperation);<br>
&nbsp;&nbsp;&nbsp;&nbsp;finally<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FindClose(FindRec);<br>
&nbsp;&nbsp;&nbsp;&nbsp;end;<br>
&nbsp;&nbsp;end;<br>
end;<br>
<br>
procedure&nbsp;GetDirSize(const&nbsp;Dir,FileMask:string;IncludeSubDirs:boolean);<br>
var<br>
&nbsp;&nbsp;FindRec:TFindRec;<br>
&nbsp;&nbsp;sFileName,d:string;<br>
///&nbsp;i:Int64;<br>
begin<br>
&nbsp;&nbsp;d:=AddBackslash(Dir);<br>
&nbsp;&nbsp;if&nbsp;FindFirst(d+FileMask,FindRec)&nbsp;then&nbsp;begin<br>
&nbsp;&nbsp;&nbsp;&nbsp;try<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;repeat<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sFileName:=d+FindRec.Name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((FindRec.Attributes&nbsp;and&nbsp;FILE_ATTRIBUTE_DIRECTORY)=0)&nbsp;then&nbsp;DS:=DS+4294967295*FindRec.SizeHigh+FindRec.SizeLow<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;IncludeSubDirs&nbsp;then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(FindRec.Name&lt;&gt;'')&nbsp;and&nbsp;(FindRec.Name&lt;&gt;'.')&nbsp;and&nbsp;(FindRec.Name&lt;&gt;'..')&nbsp;then&nbsp;GetDirSize(sFileName,FileMask,IncludeSubDirs);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AppProcessMessage;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;until&nbsp;not&nbsp;(FindNext(FindRec)&nbsp;and&nbsp;not&nbsp;CancelOperation);<br>
&nbsp;&nbsp;&nbsp;&nbsp;finally<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FindClose(FindRec);<br>
&nbsp;&nbsp;&nbsp;&nbsp;end;<br>
&nbsp;&nbsp;end;<br>
end;<br>
<br>
procedure&nbsp;CancelBtnClick(Sender:TObject);<br>
begin<br>
&nbsp;&nbsp;CancelOperation:=True;<br>
end;<br>
<br>
procedure&nbsp;InitializeWizard();<br>
begin<br>
&nbsp;&nbsp;Page:=CreateInputDirPage(wpSelectTasks,'Пример&nbsp;копирования&nbsp;файлов',&nbsp;'Укажите&nbsp;каталоги','',False,'NewFolder');<br>
&nbsp;&nbsp;Page.Add('Откуда&nbsp;копировать');<br>
&nbsp;&nbsp;Page.Values[0]&nbsp;:=&nbsp;'e:\1\1';///'c:\';//ExpandConstant('{userappdata}');<br>
&nbsp;&nbsp;Page.Add('Куда&nbsp;копировать');<br>
&nbsp;&nbsp;Page.Values[1]&nbsp;:=&nbsp;'e:\1\2';///'c:\';<br>
&nbsp;&nbsp;PB:=TNewProgressBar.Create(WizardForm);<br>
&nbsp;&nbsp;with&nbsp;PB&nbsp;do&nbsp;begin<br>
&nbsp;&nbsp;&nbsp;&nbsp;Left:=0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Top:=130;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Width:=Page.Surface.Width;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Parent:=Page.Surface;<br>
&nbsp;&nbsp;end;<br>
&nbsp;&nbsp;L1:=TNewStaticText.Create(WizardForm);<br>
&nbsp;&nbsp;with&nbsp;L1&nbsp;do&nbsp;begin<br>
&nbsp;&nbsp;&nbsp;&nbsp;Left:=0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Top:=115;<br>
&nbsp;&nbsp;&nbsp;&nbsp;AutoSize:=False;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Width:=Page.Surface.Width-30;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Parent:=Page.Surface;<br>
&nbsp;&nbsp;end;<br>
&nbsp;&nbsp;L2:=TNewStaticText.Create(WizardForm);<br>
&nbsp;&nbsp;with&nbsp;L2&nbsp;do&nbsp;begin<br>
&nbsp;&nbsp;&nbsp;&nbsp;Left:=Page.Surface.Width-30;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Top:=115;<br>
&nbsp;&nbsp;&nbsp;&nbsp;AutoSize:=False;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Width:=30;<br>
&nbsp;&nbsp;&nbsp;&nbsp;///Alignment:=taRightJustify;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Parent:=Page.Surface;<br>
&nbsp;&nbsp;end;<br>
&nbsp;&nbsp;PB2:=TNewProgressBar.Create(WizardForm);<br>
&nbsp;&nbsp;with&nbsp;PB2&nbsp;do&nbsp;begin<br>
&nbsp;&nbsp;&nbsp;&nbsp;Left:=0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Top:=170;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Width:=Page.Surface.Width;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Parent:=Page.Surface;<br>
&nbsp;&nbsp;end;<br>
&nbsp;&nbsp;L3:=TNewStaticText.Create(WizardForm);<br>
&nbsp;&nbsp;with&nbsp;L3&nbsp;do&nbsp;begin<br>
&nbsp;&nbsp;&nbsp;&nbsp;Left:=Page.Surface.Width-30;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Top:=155;<br>
&nbsp;&nbsp;&nbsp;&nbsp;AutoSize:=False;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Width:=30;<br>
&nbsp;&nbsp;&nbsp;&nbsp;///Alignment:=taRightJustify;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Parent:=Page.Surface;<br>
&nbsp;&nbsp;end;<br>
&nbsp;&nbsp;CancelBtn:=TButton.Create(WizardForm);<br>
&nbsp;&nbsp;with&nbsp;CancelBtn&nbsp;do&nbsp;begin<br>
&nbsp;&nbsp;&nbsp;&nbsp;Left:=Page.Surface.Width-150;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Top:=200;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Width:=150;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Parent:=Page.Surface;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Caption:='Отменить&nbsp;копирование';<br>
&nbsp;&nbsp;&nbsp;&nbsp;OnClick:=@CancelBtnClick;<br>
&nbsp;&nbsp;end;<br>
<br>
end;<br>
<br>
function&nbsp;NextButtonClick(CurPageID:&nbsp;Integer):&nbsp;Boolean;<br>
begin<br>
&nbsp;&nbsp;Result:=True;<br>
&nbsp;&nbsp;if&nbsp;CurPageID=Page.ID&nbsp;then&nbsp;begin<br>
&nbsp;&nbsp;&nbsp;&nbsp;L1.Caption:='Подсчет&nbsp;размера&nbsp;&quot;'+Page.Values[0]+'&quot;';<br>
&nbsp;&nbsp;&nbsp;&nbsp;L2.Caption:='';<br>
&nbsp;&nbsp;&nbsp;&nbsp;L3.Caption:='';<br>
&nbsp;&nbsp;&nbsp;&nbsp;DS:=0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;PB.Position:=0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;PB.Max:=100;<br>
&nbsp;&nbsp;&nbsp;&nbsp;PB2.Position:=0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;PB2.Max:=100;<br>
&nbsp;&nbsp;&nbsp;&nbsp;CS:=0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;CancelOperation:=False;<br>
&nbsp;&nbsp;&nbsp;&nbsp;WizardForm.NextButton.Enabled:=False;<br>
&nbsp;&nbsp;&nbsp;&nbsp;WizardForm.CancelButton.Enabled:=False;<br>
&nbsp;&nbsp;&nbsp;&nbsp;WizardForm.BackButton.Enabled:=False;<br>
&nbsp;&nbsp;&nbsp;&nbsp;GetDirSize(Page.Values[0],'*.*',True);<br>
&nbsp;&nbsp;&nbsp;&nbsp;CopyDir(Page.Values[0],Page.Values[1],'*.*',True);<br>
&nbsp;&nbsp;&nbsp;&nbsp;WizardForm.NextButton.Enabled:=True;<br>
&nbsp;&nbsp;&nbsp;&nbsp;WizardForm.CancelButton.Enabled:=True;<br>
&nbsp;&nbsp;&nbsp;&nbsp;WizardForm.BackButton.Enabled:=True;<br>
&nbsp;&nbsp;end;<br>
end;
</font></blockquote><textarea id="taCode1" style="display:none;" rows="1" cols="5"></textarea><textarea id='taCode' style='display:none;' rows='1' cols='20'></textarea></code><script language="javascript" type="text/javascript">highlightSyntax('delphi_Tc4NTM','delphi');</script><br><div id="heading"><h1><font size="1" face="Consolas">Copyright (c) <a href="http://www.krinkels.org/" target="_blank">Krinkels Inc</a></font></h1></div></body></html>