<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"><title>Время до завершения</title><link rel="stylesheet" type="text/css" href="css.css"><script type="text/javascript" src="includer.js"></script><script language='jscript' type='text/javascript' src='copycode.js'></script></head><body><div id="heading"><h1>» Inno Setup Faq. Время до завершения</h1></div><br><script language="javascript" type="text/javascript">includeSyntax('delphi');</script><code id="delphi_Tc4NTM"> <input type="button" value="Копировать в буфер обмена" onClick="copyToClipboard( taCode1, theCode1 );"> <blockquote id="theCode1"><font>[Setup]<br>AppName=FreeArc Example<br>AppVerName=FreeArc Example 3.3 Extreme<br>DefaultDirName={pf}\FreeArc Example<br><br>[Files]<br>Source: compiler:innocallback.dll; DestDir: {tmp}; Flags: dontcopy;<br>Source: {win}\Help\; DestDir: {app}; Flags: external;<br><br>[Languages]<br>Name: rus; MessagesFile: compiler:Languages\Russian.isl<br><br>[Name]<br>Name: rus; Name: compiler:Name\Russian.isl<br><br>[CustomMessages]<br>rus.hour= часов<br>rus.min= мин<br>rus.sec= сек<br><br>[Code]<br>type<br>TTimerProc = procedure(HandleW, Msg, idEvent, TimeSys: LongWord);<br><br>var<br>StartInstall: Integer;<br>TimeLabel: TLabel;<br>TimerID: Longword;<br><br>function GetTickCount: DWord; external 'GetTickCount@kernel32';<br>function WrapTimerProc(callback: TTimerProc; Paramcount: Integer): longword; external 'wrapcallback@files:innocallback.dll stdcall';<br>function SetTimer(hWnd, nIDEvent, uElapse, lpTimerFunc: LongWord): longword; external 'SetTimer@user32';<br>function KillTimer(hWnd, nIDEvent: LongWord): LongWord; external 'KillTimer@user32 stdcall delayload';<br><br>function cm(Message: String): String; Begin Result:= ExpandConstant('{cm:'+ Message +'}') end;<br><br>function TicksToTime(Ticks: DWord; h,m,s: String; detail: Boolean): String;<br>Begin<br>&nbsp; &nbsp; if detail then&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {{hh: mm:ss format}<br>&nbsp; &nbsp; &nbsp; &nbsp; Result:= PADZ(IntToStr(Ticks/3600000), 2) +':'+ PADZ(IntToStr((Ticks/1000 - Ticks/1000/3600*3600)/60), 2) +':'+ PADZ(IntToStr(Ticks/1000 - Ticks/1000/60*60), 2)<br>&nbsp; &nbsp; else if Ticks/3600 &gt;= 1000 then&nbsp; &nbsp; {{more than hour}<br>&nbsp; &nbsp; &nbsp; &nbsp; Result:= IntToStr(Ticks/3600000) +h+' '+ PADZ(IntToStr((Ticks/1000 - Ticks/1000/3600*3600)/60), 2) +m<br>&nbsp; &nbsp; else if Ticks/60 &gt;= 1000 then&nbsp; &nbsp; {{1..60 minutes}<br>&nbsp; &nbsp; &nbsp; &nbsp; Result:= IntToStr(Ticks/60000) +m+' '+ IntToStr(Ticks/1000 - Ticks/1000/60*60) +s<br>&nbsp; &nbsp; else Result:= Format('%.1n', [Abs(Ticks/1000)]) +s&nbsp; &nbsp; {{less than one minute}<br>end;<br><br>procedure GetTime(HandleW, Msg, idEvent, TimeSys: LongWord);<br>var Remaining: Integer;<br>begin<br>with WizardForm.ProgressGauge do begin<br>&nbsp; if position &gt; 0 then Remaining:= trunc((GetTickCount - StartInstall) * Abs((max - position)/position))<br>&nbsp; &nbsp; TimeLabel.Caption:= 'Осталось ' + TicksToTime(Remaining, cm('hour'), cm('min'), cm('sec'), false)<br>&nbsp; &nbsp; if (Remaining = 0) then TimeLabel.Caption:= 'Завершение...'<br>&nbsp; end;<br>end;<br><br>procedure InitializeWizard();<br>begin<br>TimeLabel:= TLabel.Create(WizardForm)<br>TimeLabel.SetBounds(ScaleX(0), ScaleY(80), ScaleX(457), ScaleY(20));<br>TimeLabel.AutoSize:= False<br>TimeLabel.Transparent:= True;<br>TimeLabel.Parent:= WizardForm.InstallingPage;<br>end;<br><br>procedure CurStepChanged(CurStep: TSetupStep);<br>begin<br>If CurStep = ssInstall then<br>&nbsp; begin<br>&nbsp; &nbsp; StartInstall:= GetTickCount<br>&nbsp; &nbsp; TimerID:= SetTimer(0,0, 500, WrapTimerProc(@GetTime, 4))<br>&nbsp; end;<br>end;<br><br>procedure DeinitializeSetup();<br>begin<br>KillTimer(0, TimerID)<br>end;</font></blockquote><textarea id="taCode1" style="display:none;" rows="1" cols="5"></textarea><textarea id='taCode' style='display:none;' rows='1' cols='20'></textarea></code><script language="javascript" type="text/javascript">highlightSyntax('delphi_Tc4NTM','delphi');</script><br><div id="heading"><h1><font size="1" face="Consolas">Copyright (c) <a href="http://www.krinkels.org/" target="_blank">Krinkels Inc</a></font></h1></div></body></html>