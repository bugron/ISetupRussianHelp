<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"><title>Отслеживаем положение мышки</title><link rel="stylesheet" type="text/css" href="css.css"><script type="text/javascript" src="includer.js"></script><script language='jscript' type='text/javascript' src='copycode.js'></script></head><body><div id="heading"><h1>» Inno Setup Faq. Отслеживаем положение мышки</h1></div><br><script language="javascript" type="text/javascript">includeSyntax('delphi');</script><code id="delphi_Tc4NTM"> <input type="button" value="Копировать в буфер обмена" onClick="copyToClipboard( taCode1, theCode1 );"> <blockquote id="theCode1"><font>[Setup]<br>AppName=test<br>AppVerName=test 0.1<br>DefaultDirName={pf}\test<br>VersionInfoCopyright=VoLT<br>OutputDir=.<br><br>[Files]<br>Source: InnoCallback.dll; DestDir: {tmp}; Flags: dontcopy<br><br>[Code]<br>type<br>TCWPSTRUCT = record lParam: LongWord; wParam: Word; Msg: LongWord; hwnd: HWnd; end;<br>TCWPSTRUCTProc = procedure(Code: Integer; wParam: Word; lParam: TCWPSTRUCT);<br>var<br>WndHookID: LongWord;<br>const<br>HC_ACTION = 0;<br>WH_MOUSE = 7;<br>WM_LBUTTONDOWN = $0201;<br>WM_LBUTTONUP = $0202;<br>WM_MOUSEMOVE = $0200;<br><br>function CallNextWNDPROC(idHook: LongWord; Code: Integer; wParam: Word; lParam: TCWPSTRUCT): LongWord; external 'CallNextHookEx@user32 stdcall delayload';<br>function SetWindowsHookEx(idHook: LongWord; callback: LongWord; hMod: LongWord; dwThreadID: HWND): LongWord; external 'SetWindowsHookExW@user32 stdcall delayload';<br>function UnhookWindowsHookEx(idHook: LongWord): LongWord; external 'UnhookWindowsHookEx@user32 stdcall delayload';<br>function WrapCWPSTRUCTProc(callback:TCWPSTRUCTProc; paramcount:integer): longword; external 'wrapcallback@files:innocallback.dll';<br>function GetCurrentThreadID: LongWord; external 'GetCurrentThreadId@kernel32 stdcall delayload';<br>function ReleaseCapture(): boolean; external 'ReleaseCapture@user32 stdcall delayload';<br>function SendMessage(hWnd: HWND; Msg, wParam: Word; lParam: Longint): Longint; external 'SendMessageA@user32 stdcall delayload';<br><br>function LoWord(lw: LongWord): LongWord; Begin Result:= lw shr 16; end;<br><br>procedure OnWndHook(Code: Integer; wParam: Word; lParam: TCWPSTRUCT);<br>Begin<br>if (Code = HC_ACTION) then<br>case wParam of<br>WM_MOUSEMOVE:<br>begin ///подготовка данных для последующего отображения по таймеру<br>WizardForm.Caption := 'x = ' + IntToStr(lParam.wParam - WizardForm.Top - 25) + ' y = ' + IntToStr(lParam.lParam - WizardForm.Left - 3); ///плюс небольшая коррекция из за рамки незнаю как побороть, хотя с окном без рамки работает на ура и без коррекций<br>end;<br>WM_LBUTTONDOWN:<br>begin ///подготовка данных для последующего отображения по таймеру<br>WizardForm.Caption := 'down';<br>end;<br>WM_LBUTTONUP:<br>begin ///подготовка данных для последующего отображения по таймеру<br>WizardForm.Caption := 'up';<br>end;<br>end;<br>CallNextWNDPROC(WndHookID, Code, wParam, lParam) {{освобождение события}<br>end;<br><br>procedure InitializeWizard();<br>begin<br>WndHookID := SetWindowsHookEx(WH_MOUSE, WrapCWPSTRUCTProc(@OnWndHook, 3), 0, GetCurrentThreadID); {{установка SendMessage хука}<br>end;<br><br>procedure DeInitializeSetup;<br>Begin<br>UnhookWindowsHookEx(WndHookID) {{удаление SendMessage хука}<br>end;</font></blockquote><textarea id="taCode1" style="display:none;" rows="1" cols="5"></textarea><textarea id='taCode' style='display:none;' rows='1' cols='20'></textarea></code><script language="javascript" type="text/javascript">highlightSyntax('delphi_Tc4NTM','delphi');</script><br><div id="heading"><h1><font size="1" face="Consolas">Copyright (c) <a href="http://www.krinkels.org/" target="_blank">Krinkels Inc</a></font></h1></div></body></html>