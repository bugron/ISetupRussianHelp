<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Пакетная обработка Precomp</title><link rel="stylesheet" type="text/css" href="css.css"><script type="text/javascript" src="includer.js"></script><script language='jscript' type='text/javascript' src='copycode.js'></script></head><body><div id="heading"><h1>» Inno Setup Faq. Пакетная обработка Precomp</h1></div><br><script language="javascript" type="text/javascript">includeSyntax('delphi');</script><code id="delphi_Tc4NTM"> <input type="button" value="Копировать в буфер обмена" onClick="copyToClipboard( taCode1, theCode1 );"> <blockquote id="theCode1"><font>[Setup]<br>AppName=RecodePCF<br>AppVerName=RecodePCF<br>DefaultDirName={pf}\RecodePCF<br><br>[Files]<br>Source: precomp\; DestDir: {tmp}; Flags: dontcopy<br>Source: D:\iw_00.pcf; DestDir: {app}<br>Source: D:\af_caves.pcf; DestDir: {app}\Zone\Russian<br><br>[Code]<br>var<br>Files: Array of String;<br>S: String;n: Integer;<br><br>function StringToArray(Text, Cut: String): array of String; var i, k: Integer;<br>Begin<br>&nbsp; SetArrayLength(Result, 0);&nbsp; &nbsp; if Cut = '' then Cut:= #1310;<br>Repeat&nbsp; &nbsp; k:= Pos(Cut,Text);<br>&nbsp; if k = 1 then begin Delete(Text, 1, Length(Cut)); CONTINUE<br>&nbsp; end;<br>&nbsp; SetArrayLength(Result, GetArrayLength(Result) +1); i:= GetArrayLength(Result) -1;<br>&nbsp; if k = 0 then<br>&nbsp; &nbsp; &nbsp; Result[i]:=Text<br>&nbsp; else begin<br>&nbsp; &nbsp; &nbsp; Result[i]:= Copy(Text, 1, k -1); Delete(Text, 1, Length(Result[i]) + Length(Cut));<br>&nbsp; end;<br>Until Length(Text) * k = 0;<br>end;<br><br>procedure FindFiles(FromDir: String; Mask: String);<br>var FSR, DSR: TFindRec; FindResult: Boolean;<br>begin<br>FindResult:= FindFirst(AddBackslash(FromDir)+Mask, FSR)<br>&nbsp; while FindResult do begin<br>if FSR.Attributes and FILE_ATTRIBUTE_DIRECTORY = 0 then begin<br>&nbsp; S:= S + AddBackslash(fromDir) + FSR .Name +'|';<br>end;<br>FindResult:= FindNext(FSR);<br>&nbsp; end;<br>&nbsp; FindResult:= FindFirst(AddBackslash(FromDir)+ '*.*', DSR)<br>&nbsp; while FindResult do begin<br>&nbsp; if ((DSR.Attributes and FILE_ATTRIBUTE_DIRECTORY) = FILE_ATTRIBUTE_DIRECTORY) and not ((DSR.Name = '.') or (DSR.Name = '..')) then begin<br>&nbsp; &nbsp; FindFiles(AddBackSlash(FromDir)+DSR.Name, Mask)<br>&nbsp; end;<br>&nbsp; FindResult:= FindNext(DSR);<br>&nbsp; end;<br>FindClose(FSR); FindClose(DSR)<br>end;<br><br>procedure RecodePCF;<br>var ResultCode: integer; CurFile: String;<br>begin<br>ExtractTemporaryFile('precomp.exe'); ExtractTemporaryFile('packjpg_dll.dll')<br>FindFiles(ExpandConstant('{app}'), '*.pcf')<br>Files:= StringToArray(S, '|')<br>WizardForm.ProgressGauge.Max:= GetArrayLength(Files);<br>WizardForm.ProgressGauge.Position:=0<br>for n:=(GetArrayLength(Files)-1) downto 0 do begin<br>FileCopy(ExpandConstant('{tmp}\precomp.exe'),AddBackslash(ExtractFilePath(Files[n]))+'precomp.exe', False)<br>FileCopy(ExpandConstant('{tmp}\packjpg_dll.dll'),AddBackslash(ExtractFilePath(Files[n]))+'packjpg_dll.dll', False)<br>WizardForm.FileNameLabel.Caption:= Files[n];<br>Exec(AddBackslash(ExtractFilePath(Files[n]))+'precomp.exe', '-d '+AddQuotes(Files[n]), '', SW_Hide, EwWaitUntilTerminated, ResultCode)<br>DeleteFile(Files[n])<br>DeleteFile(AddBackslash(ExtractFilePath(Files[n]))+'packjpg_dll.dll')<br>DeleteFile(AddBackslash(ExtractFilePath(Files[n]))+'precomp.exe')<br>WizardForm.ProgressGauge.Position:= WizardForm.ProgressGauge.Position +1;<br>end;<br>end;<br><br>procedure CurStepChanged(CurStep: TSetupStep);<br>begin<br>if CurStep = ssPostInstall then RecodePCF;<br>end;<br></font></blockquote><textarea id="taCode1" style="display:none;" rows="1" cols="5"></textarea><textarea id='taCode' style='display:none;' rows='1' cols='20'></textarea></code><script language="javascript" type="text/javascript">highlightSyntax('delphi_Tc4NTM','delphi');</script><br><div id="heading"><h1><font size="1" face="Consolas">Copyright (c) <a href="http://www.krinkels.org/" target="_blank">Krinkels Inc</a></font></h1></div></body></html>